<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gestor PRO CalorÃ­as & Macros</title>

<!-- PWA -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#22c55e">
<link rel="apple-touch-icon" href="icon-192.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:#0f172a;color:white;margin:0;padding:20px}
.container{max-width:1400px;margin:auto;background:#111827;padding:20px;border-radius:15px}
input,select,button{padding:10px;margin:5px;border-radius:8px;border:none}
button{background:#22c55e;color:white;font-weight:bold;cursor:pointer}
button:hover{opacity:.85}
table{width:100%;margin-top:20px;border-collapse:collapse}
th,td{padding:10px;text-align:center;border-bottom:1px solid #374151}
canvas{background:white;border-radius:10px;padding:8px}

.dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:15px}
.card{background:#1f2937;padding:10px;border-radius:10px;text-align:center}
.progress{background:#374151;border-radius:10px;height:16px;margin-top:5px}
.bar{height:100%;background:#22c55e;width:0%}

.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:20px}
.chart-box canvas{height:140px !important}

.meals-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-top:20px}
.meal-box{background:#020617;padding:10px;border-radius:10px}

.install-box{margin-top:15px;padding:10px;background:#020617;border-radius:10px;text-align:center}
</style>
</head>
<body>

<div class="container">
<h1>ğŸ“Š Gestor PRO CalorÃ­as & Macronutrientes</h1>

<div class="install-box">
<button id="installBtn" style="display:none">ğŸ“² Instalar App</button>
</div>

<!-- FECHA -->
<h3>ğŸ“… Historial por fecha</h3>
<input type="date" id="datePicker" onchange="changeDate()">
<button onclick="repeatDay()">ğŸ“‹ Repetir dÃ­a anterior</button>

<!-- DASHBOARD -->
<div class="dashboard">
<div class="card"><h4>Kcal</h4><h2 id="dashKcal">0</h2></div>
<div class="card"><h4>ProteÃ­na</h4><h2 id="dashPro">0</h2></div>
<div class="card"><h4>Carbs</h4><h2 id="dashCar">0</h2></div>
<div class="card"><h4>Grasas</h4><h2 id="dashFat">0</h2></div>
</div>

<!-- PROGRESO -->
<h3>ğŸ¯ Progreso diario</h3>
Kcal<div class="progress"><div id="barKcal" class="bar"></div></div>
ProteÃ­na<div class="progress"><div id="barPro" class="bar"></div></div>
Carbs<div class="progress"><div id="barCar" class="bar"></div></div>
Grasas<div class="progress"><div id="barFat" class="bar"></div></div>

<!-- PERFIL -->
<h3>ğŸ‘¤ Requerimientos</h3>
<input id="reqCal" type="number" placeholder="CalorÃ­as">
<input id="reqPro" type="number" placeholder="ProteÃ­na">
<input id="reqCar" type="number" placeholder="Carbs">
<input id="reqFat" type="number" placeholder="Grasas">
<button onclick="saveProfile()">Guardar</button>

<!-- BUSCADOR -->
<h3>ğŸ” Buscar alimento</h3>
<input id="searchFood" placeholder="Buscar..." oninput="searchDB()">
<select id="foodSelect" size="6" style="width:100%"></select>
<button onclick="fillFromDB()">Autocompletar</button>

<!-- PORCIÃ“N -->
<h3>âš–ï¸ PorciÃ³n</h3>
<input type="number" id="grams" placeholder="Gramos" oninput="applyCustomGrams()">

<!-- AÃ‘ADIR -->
<h3>ğŸ½ï¸ AÃ±adir consumo</h3>
<select id="mealType">
<option>Desayuno</option>
<option>Almuerzo</option>
<option>Cena</option>
<option>Snacks</option>
</select>

<input id="food" placeholder="Comida">
<input id="calories" type="number" placeholder="Kcal">
<input id="protein" type="number" placeholder="ProteÃ­na">
<input id="carbs" type="number" placeholder="Carbs">
<input id="fat" type="number" placeholder="Grasas">
<button onclick="addFood()">Agregar</button>

<!-- TABLA -->
<table>
<thead><tr><th>Comida</th><th>Tipo</th><th>Kcal</th><th>P</th><th>C</th><th>G</th><th>ğŸ—‘ï¸</th></tr></thead>
<tbody id="foodTable"></tbody>
</table>

<!-- DIVISIÃ“N -->
<div class="meals-grid">
<div class="meal-box"><h4>Desayuno</h4><div id="mealDes"></div></div>
<div class="meal-box"><h4>Almuerzo</h4><div id="mealAlm"></div></div>
<div class="meal-box"><h4>Cena</h4><div id="mealCena"></div></div>
<div class="meal-box"><h4>Snacks</h4><div id="mealSnack"></div></div>
</div>

<!-- GRÃFICAS -->
<div class="charts-grid">
<div class="chart-box"><h3>Macros diario</h3><canvas id="macroChart"></canvas></div>
<div class="chart-box"><h3>Kcal semanales</h3><canvas id="weeklyChart"></canvas></div>
</div>

</div>

<script>

/* PERFIL */
let profile=JSON.parse(localStorage.getItem("userProfile"))||{calories:2000,protein:150,carbs:250,fat:70};
reqCal.value=profile.calories;reqPro.value=profile.protein;reqCar.value=profile.carbs;reqFat.value=profile.fat;
function saveProfile(){
profile={calories:+reqCal.value,protein:+reqPro.value,carbs:+reqCar.value,fat:+reqFat.value};
localStorage.setItem("userProfile",JSON.stringify(profile));
render();}

/* HISTORIAL */
let history=JSON.parse(localStorage.getItem("dailyHistory"))||{};
let today=new Date().toISOString().slice(0,10);
let currentDate=today;
datePicker.value=currentDate;
let list=history[currentDate]||[];

function saveDay(){history[currentDate]=list;localStorage.setItem("dailyHistory",JSON.stringify(history));}
function changeDate(){currentDate=datePicker.value;list=history[currentDate]||[];render();}
function repeatDay(){const d=new Date(currentDate);d.setDate(d.getDate()-1);list=[...(history[d.toISOString().slice(0,10)]||[])];saveDay();render();}

/* BD */
let db=JSON.parse(localStorage.getItem("foodDB"))||[{name:"Pollo",cal:165,pro:31,car:0,fat:3.6}];
function searchDB(){
foodSelect.innerHTML="";
db.filter(f=>f.name.toLowerCase().includes(searchFood.value.toLowerCase()))
.forEach((f,i)=>foodSelect.innerHTML+=`<option value=${i}>${f.name}</option>`);
}
searchDB();

let baseFood=null;
function fillFromDB(){
const f=db[foodSelect.value];if(!f)return;
baseFood=f;
food.value=f.name;calories.value=f.cal;protein.value=f.pro;carbs.value=f.car;fat.value=f.fat;grams.value=100;
}

function applyCustomGrams(){
if(!baseFood)return;
const m=(+grams.value||0)/100;
calories.value=(baseFood.cal*m).toFixed(0);
protein.value=(baseFood.pro*m).toFixed(1);
carbs.value=(baseFood.car*m).toFixed(1);
fat.value=(baseFood.fat*m).toFixed(1);
}

/* CRUD */
function addFood(){
list.push({food:food.value,type:mealType.value,cal:+calories.value||0,pro:+protein.value||0,car:+carbs.value||0,fat:+fat.value||0});
saveDay();render();}

function deleteFood(i){list.splice(i,1);saveDay();render();}

/* CHARTS */
let macroChart,weeklyChart;

function render(){
foodTable.innerHTML="";
mealDes.innerHTML="";mealAlm.innerHTML="";mealCena.innerHTML="";mealSnack.innerHTML="";

let p=0,c=0,f=0,k=0;

list.forEach((x,i)=>{
p+=x.pro;c+=x.car;f+=x.fat;k+=x.cal;
foodTable.innerHTML+=`<tr><td>${x.food}</td><td>${x.type}</td><td>${x.cal}</td><td>${x.pro}</td><td>${x.car}</td><td>${x.fat}</td><td><button onclick="deleteFood(${i})" style="background:#ef4444">X</button></td></tr>`;

const box=x.type==="Desayuno"?mealDes:x.type==="Almuerzo"?mealAlm:x.type==="Cena"?mealCena:mealSnack;
box.innerHTML+=`${x.food} (${x.cal} kcal)<br>`;
});

dashKcal.textContent=k;dashPro.textContent=p;dashCar.textContent=c;dashFat.textContent=f;

barKcal.style.width=(k/profile.calories*100)+"%";
barPro.style.width=(p/profile.protein*100)+"%";
barCar.style.width=(c/profile.carbs*100)+"%";
barFat.style.width=(f/profile.fat*100)+"%";

/* ---- MACRO CHART ---- */
const macroCanvas=document.getElementById("macroChart");
if(macroCanvas){
const ctx=macroCanvas.getContext("2d");
if(macroChart)macroChart.destroy();
macroChart=new Chart(ctx,{ 
 type:'doughnut',
 data:{
  labels:['ProteÃ­na','Carbs','Grasas'],
  datasets:[{data:[p,c,f]}]
 }
});
}

renderWeekly();
}

function renderWeekly(){
const labels=[],kcals=[];

for(let i=6;i>=0;i--){
 const date=new Date();
 date.setDate(date.getDate()-i);
 const key=date.toISOString().slice(0,10);
 labels.push(key.slice(5));
 kcals.push((history[key]||[]).reduce((a,b)=>a+b.cal,0));
}

const weeklyCanvas=document.getElementById("weeklyChart");
if(weeklyCanvas){
 const ctx=weeklyCanvas.getContext("2d");
 if(weeklyChart)weeklyChart.destroy();
 weeklyChart=new Chart(ctx,{ 
  type:'bar',
  data:{
   labels:labels,
   datasets:[{label:'Kcal',data:kcals}]
  }
 });
}
}

/* INIT */
document.addEventListener("DOMContentLoaded",()=>{
 render();
 registerSW();
});

/* PWA INSTALL */
let deferredPrompt;

window.addEventListener("beforeinstallprompt",e=>{
 e.preventDefault();
 deferredPrompt=e;
 const btn=document.getElementById("installBtn");
 if(btn) btn.style.display="inline-block";
 console.log("PWA install disponible");
});

document.getElementById("installBtn").addEventListener("click",async()=>{
 if(!deferredPrompt){
  alert("InstalaciÃ³n no disponible aÃºn. Abre la app varias veces o verifica HTTPS.");
  return;
 }
 deferredPrompt.prompt();
 deferredPrompt=null;
 document.getElementById("installBtn").style.display="none";
});

/* SERVICE WORKER */
function registerSW(){
 if("serviceWorker" in navigator){
  navigator.serviceWorker.register("./sw.js");
 }
}
</script>
</body>
</html>
