<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Gestor PRO Calor√≠as V2.1</title>

<meta name="theme-color" content="#22c55e">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    :root { --primary: #22c55e; --dark: #0f172a; --card: #1f2937; --text: #f1f5f9; }
    body{font-family: 'Segoe UI', system-ui, sans-serif; background:var(--dark); color:var(--text); margin:0; padding:20px; padding-bottom: 80px;}
    
    /* Contenedor principal */
    .container{
        max-width:1000px; margin:auto; background:#111827; padding:20px; border-radius:15px; 
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        animation: fadeIn 0.5s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Inputs y Botones */
    input, select, button{
        padding:12px; margin:5px 0; border-radius:8px; border:1px solid #374151; 
        background: #1f2937; color: white; width: 100%; box-sizing: border-box; font-size: 16px;
    }
    input:focus, select:focus { border-color: var(--primary); outline: none; }
    
    button{background:var(--primary); border:none; font-weight:bold; cursor:pointer; transition: transform 0.1s;}
    button:active { transform: scale(0.98); }
    
    /* Layouts */
    .dashboard{display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:15px; margin-top:20px}
    .card{background:#1f2937; padding:15px; border-radius:10px; text-align:center; border: 1px solid #374151;}
    .card h4 {margin:0 0 10px; color:#94a3b8; font-size:0.9rem; text-transform:uppercase;}
    .card h2 {margin:0; font-size:1.8rem;}

    .charts-grid{display:grid; grid-template-columns: 1fr; gap:20px; margin-top:20px}
    @media(min-width: 768px) { .charts-grid{grid-template-columns: 1fr 1fr;} }
    
    .chart-box {background: #1f2937; padding: 15px; border-radius: 12px; position: relative; height: 300px; display:flex; flex-direction:column; justify-content:center;}
    canvas {max-width: 100%; max-height: 250px;}

    /* Barras de Progreso */
    .progress-wrapper {margin-bottom: 15px;}
    .progress-bg {background:#374151; border-radius:10px; height:14px; overflow:hidden;}
    .bar {height:100%; width:0%; transition: width 0.5s ease-out; background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 1rem 1rem;}
    
    /* Tabla */
    .table-container {overflow-x: auto; margin-top: 20px;}
    table {width: 100%; border-collapse: collapse; min-width: 500px;}
    th, td {padding: 12px; text-align: left; border-bottom: 1px solid #374151;}
    th {background: #1f2937;}
    
    /* Comidas Grid */
    .meals-grid {display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:15px; margin-top:20px;}
    .meal-col {background: #0f172a; padding:15px; border-radius:10px; border-left: 4px solid var(--primary);}
    .meal-item {border-bottom: 1px dashed #334155; padding: 5px 0; font-size: 0.9rem; display: flex; justify-content: space-between;}

    /* Utilidades */
    .flex-row {display:flex; gap:10px;}
    .hidden {display:none;}
    .over-limit { background-color: #ef4444 !important; box-shadow: 0 0 10px #ef4444; }
</style>
</head>
<body>

<div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>üìä Gestor PRO <small style="font-size:0.5em; opacity:0.7">v2.1</small></h1>
        <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px;">
            <input type="checkbox" id="soundToggle" checked style="width:auto; margin:0;"> üîä Sonido
        </label>
    </div>

    <div class="card" style="text-align:left; display:flex; align-items:center; justify-content:space-between; gap:10px;">
        <div>
            <label style="font-size:0.8rem; color:#94a3b8">FECHA SELECCIONADA</label>
            <input type="date" id="datePicker" onchange="changeDate()" style="margin:0;">
        </div>
        <button onclick="repeatDay()" style="width:auto; background:#3b82f6;">üìã Copiar Ayer</button>
    </div>

    <div class="dashboard">
        <div class="card"><h4>Calor√≠as</h4><h2 id="dashKcal">0</h2></div>
        <div class="card"><h4>Prote√≠na</h4><h2 id="dashPro">0</h2></div>
        <div class="card"><h4>Carbs</h4><h2 id="dashCar">0</h2></div>
        <div class="card"><h4>Grasas</h4><h2 id="dashFat">0</h2></div>
    </div>

    <div style="margin-top:20px; background:#1f2937; padding:20px; border-radius:12px;">
        <h3>üéØ Meta Diaria</h3>
        
        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Kcal</span><span id="txtKcal">0%</span></div>
            <div class="progress-bg"><div id="barKcal" class="bar" style="background-color:#22c55e"></div></div>
        </div>

        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Prote√≠na</span><span id="txtPro">0%</span></div>
            <div class="progress-bg"><div id="barPro" class="bar" style="background-color:#3b82f6"></div></div>
        </div>

        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Carbs</span><span id="txtCar">0%</span></div>
            <div class="progress-bg"><div id="barCar" class="bar" style="background-color:#eab308"></div></div>
        </div>
        
        <div class="progress-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Grasas</span><span id="txtFat">0%</span></div>
            <div class="progress-bg"><div id="barFat" class="bar" style="background-color:#ef4444"></div></div>
        </div>
    </div>

    <div style="margin-top:20px;">
        <h3>üîé A√±adir Alimento</h3>
        <input id="searchFood" placeholder="Buscar (ej. Arroz, Pollo...)" oninput="searchDB()">
        <select id="foodSelect" size="3" onchange="fillFromDB()" style="display:none;"></select>
        
        <div class="flex-row">
            <input type="number" id="grams" placeholder="Gramos" oninput="applyCustomGrams()">
            <button onclick="addManualFood()" style="background:#6366f1; width:auto;">‚ûï Nuevo</button>
        </div>

        <div style="background:#0f172a; padding:15px; border-radius:10px; margin-top:10px;">
            <div class="flex-row" style="flex-wrap:wrap;">
                <select id="mealType" style="flex:1;"><option>Desayuno</option><option>Almuerzo</option><option>Cena</option><option>Snack</option></select>
                <input id="foodName" placeholder="Nombre" style="flex:2;">
            </div>
            <div class="flex-row" style="flex-wrap:wrap;">
                <input type="number" id="calories" placeholder="Kcal" style="flex:1">
                <input type="number" id="protein" placeholder="Prot" style="flex:1">
                <input type="number" id="carbs" placeholder="Carb" style="flex:1">
                <input type="number" id="fat" placeholder="Gras" style="flex:1">
            </div>
            <button onclick="addFood()" style="font-size:1.1rem; margin-top:10px;">A√ëADIR A LA LISTA</button>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead><tr><th>Alimento</th><th>Comida</th><th>Kcal</th><th>Acci√≥n</th></tr></thead>
            <tbody id="foodTable"></tbody>
        </table>
    </div>

    <div class="meals-grid">
        <div class="meal-col"><h4>‚òï Desayuno</h4><div id="listDes"></div></div>
        <div class="meal-col"><h4>ü•ó Almuerzo</h4><div id="listAlm"></div></div>
        <div class="meal-col"><h4>üåô Cena</h4><div id="listCena"></div></div>
        <div class="meal-col"><h4>üçé Snack</h4><div id="listSnack"></div></div>
    </div>

    <div class="charts-grid">
        <div class="chart-box"><canvas id="macroChart"></canvas></div>
        <div class="chart-box"><canvas id="weeklyChart"></canvas></div>
    </div>

    <div style="margin-top:30px; text-align:center;">
        <details>
            <summary style="cursor:pointer; padding:10px; background:#1f2937; border-radius:8px;">‚öôÔ∏è Configurar Mis Metas</summary>
            <div class="flex-row" style="margin-top:10px;">
                <input id="reqCal" type="number" placeholder="Kcal">
                <input id="reqPro" type="number" placeholder="Prot">
                <input id="reqCar" type="number" placeholder="Carb">
                <input id="reqFat" type="number" placeholder="Gras">
            </div>
            <button onclick="saveProfile()">Guardar Cambios</button>
        </details>
    </div>

</div>

<script>
// --- GESTOR DE AUDIO SEGURO ---
let audioCtx = null;

function playSound(type) {
    if(!document.getElementById('soundToggle').checked) return;
    
    // Iniciar contexto solo tras interacci√≥n del usuario
    if (!audioCtx) {
        try {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        } catch(e) { console.log("Audio no soportado"); return; }
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    const now = audioCtx.currentTime;

    if (type === 'success') {
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.3);
        osc.start(now); osc.stop(now + 0.3);
    } else if (type === 'click') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(800, now);
        gain.gain.setValueAtTime(0.05, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.05);
        osc.start(now); osc.stop(now + 0.05);
    } else if (type === 'delete') {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(200, now);
        gain.gain.setValueAtTime(0.1, now);
        gain.gain.linearRampToValueAtTime(0, now + 0.2);
        osc.start(now); osc.stop(now + 0.2);
    }
}

// --- DATOS ---
let profile = JSON.parse(localStorage.getItem("userProfile")) || {calories:2000, protein:150, carbs:250, fat:70};
let historyData = JSON.parse(localStorage.getItem("dailyHistory")) || {};
let currentDate = new Date().toISOString().slice(0,10);
let db = JSON.parse(localStorage.getItem("foodDB")) || [
    {name:"Arroz blanco",cal:130,pro:2.7,car:28,fat:0.3},
    {name:"Pollo pechuga",cal:165,pro:31,car:0,fat:3.6},
    {name:"Huevo",cal:155,pro:13,car:1.1,fat:11},
    {name:"Avena",cal:389,pro:17,car:66,fat:7},
    {name:"Pan Integral",cal:250,pro:12,car:45,fat:3},
    {name:"Aguacate",cal:160,pro:2,car:8.5,fat:14.7},
    {name:"Leche Entera",cal:60,pro:3,car:4.7,fat:3.2},
    {name:"Manzana",cal:52,pro:0.3,car:14,fat:0.2},
    {name:"Pl√°tano",cal:89,pro:1.1,car:22.8,fat:0.3}
];
let selectedFood = null;

// --- INICIO ---
window.onload = function() {
    try {
        document.getElementById("datePicker").value = currentDate;
        loadProfileInputs();
        render();
    } catch (e) {
        alert("Error al cargar: " + e.message);
    }
};

function loadProfileInputs() {
    document.getElementById("reqCal").value = profile.calories;
    document.getElementById("reqPro").value = profile.protein;
    document.getElementById("reqCar").value = profile.carbs;
    document.getElementById("reqFat").value = profile.fat;
}

// --- LOGICA ---
function searchDB() {
    const term = document.getElementById("searchFood").value.toLowerCase();
    const select = document.getElementById("foodSelect");
    select.innerHTML = "";
    
    if(term.length < 1) { select.style.display="none"; return; }
    
    const results = db.filter(x => x.name.toLowerCase().includes(term));
    if(results.length > 0) {
        select.style.display = "block";
        results.forEach(x => {
            let opt = document.createElement("option");
            opt.text = `${x.name} (${x.cal} kcal/100g)`;
            opt.value = x.name;
            select.add(opt);
        });
    } else {
        select.style.display = "none";
    }
}

function fillFromDB() {
    const val = document.getElementById("foodSelect").value;
    selectedFood = db.find(x => x.name === val);
    if(selectedFood) {
        document.getElementById("foodName").value = selectedFood.name;
        document.getElementById("grams").value = 100;
        applyCustomGrams();
        document.getElementById("foodSelect").style.display="none";
    }
}

function applyCustomGrams() {
    if(!selectedFood) return;
    const g = parseFloat(document.getElementById("grams").value) || 0;
    const r = g / 100;
    document.getElementById("calories").value = Math.round(selectedFood.cal * r);
    document.getElementById("protein").value = (selectedFood.pro * r).toFixed(1);
    document.getElementById("carbs").value = (selectedFood.car * r).toFixed(1);
    document.getElementById("fat").value = (selectedFood.fat * r).toFixed(1);
}

function addFood() {
    const name = document.getElementById("foodName").value;
    if(!name) { alert("Escribe un nombre"); return; }
    
    const entry = {
        name: name,
        type: document.getElementById("mealType").value,
        cal: parseFloat(document.getElementById("calories").value) || 0,
        pro: parseFloat(document.getElementById("protein").value) || 0,
        car: parseFloat(document.getElementById("carbs").value) || 0,
        fat: parseFloat(document.getElementById("fat").value) || 0
    };

    if(!historyData[currentDate]) historyData[currentDate] = [];
    historyData[currentDate].push(entry);
    
    localStorage.setItem("dailyHistory", JSON.stringify(historyData));
    playSound('success');
    
    // Limpiar campos
    document.getElementById("foodName").value="";
    document.getElementById("grams").value="";
    document.getElementById("calories").value="";
    document.getElementById("protein").value="";
    document.getElementById("carbs").value="";
    document.getElementById("fat").value="";
    
    render();
}

function deleteFood(idx) {
    if(confirm("¬øBorrar este alimento?")) {
        historyData[currentDate].splice(idx, 1);
        localStorage.setItem("dailyHistory", JSON.stringify(historyData));
        playSound('delete');
        render();
    }
}

function addManualFood() {
    const n = prompt("Nombre nuevo alimento:");
    if(!n) return;
    const c = parseFloat(prompt("Kcal por 100g:")) || 0;
    const p = parseFloat(prompt("Prote√≠na por 100g:")) || 0;
    const ch = parseFloat(prompt("Carbs por 100g:")) || 0;
    const f = parseFloat(prompt("Grasa por 100g:")) || 0;
    
    db.push({name:n, cal:c, pro:p, car:ch, fat:f});
    localStorage.setItem("foodDB", JSON.stringify(db));
    alert("Guardado en base de datos!");
}

function saveProfile() {
    profile.calories = parseFloat(document.getElementById("reqCal").value);
    profile.protein = parseFloat(document.getElementById("reqPro").value);
    profile.carbs = parseFloat(document.getElementById("reqCar").value);
    profile.fat = parseFloat(document.getElementById("reqFat").value);
    localStorage.setItem("userProfile", JSON.stringify(profile));
    playSound('success');
    render();
}

function changeDate() {
    currentDate = document.getElementById("datePicker").value;
    render();
}

function repeatDay() {
    let d = new Date(currentDate);
    d.setDate(d.getDate() - 1);
    let prev = d.toISOString().slice(0,10);
    
    if(historyData[prev]) {
        historyData[currentDate] = JSON.parse(JSON.stringify(historyData[prev]));
        localStorage.setItem("dailyHistory", JSON.stringify(historyData));
        playSound('success');
        render();
    } else {
        alert("No hay datos del d√≠a anterior");
    }
}

// --- RENDERIZADO ---
let chartMacro = null;
let chartWeekly = null;

function render() {
    const list = historyData[currentDate] || [];
    
    // Reset Views
    document.getElementById("foodTable").innerHTML = "";
    ["listDes","listAlm","listCena","listSnack"].forEach(id => document.getElementById(id).innerHTML="");
    
    let totals = {cal:0, pro:0, car:0, fat:0};

    list.forEach((item, idx) => {
        totals.cal += item.cal;
        totals.pro += item.pro;
        totals.car += item.car;
        totals.fat += item.fat;

        // Tabla Principal
        let row = `<tr>
            <td>${item.name}</td>
            <td>${item.type}</td>
            <td><b>${item.cal}</b></td>
            <td><button onclick="deleteFood(${idx})" style="background:#ef4444; padding:5px 10px;">üóëÔ∏è</button></td>
        </tr>`;
        document.getElementById("foodTable").innerHTML += row;

        // Columnas por Comida
        let boxId = item.type === "Desayuno" ? "listDes" : 
                    item.type === "Almuerzo" ? "listAlm" : 
                    item.type === "Cena" ? "listCena" : "listSnack";
        
        document.getElementById(boxId).innerHTML += 
            `<div class="meal-item"><span>${item.name}</span> <span>${item.cal} kcal</span></div>`;
    });

    // Actualizar Dashboard
    document.getElementById("dashKcal").innerText = Math.round(totals.cal);
    document.getElementById("dashPro").innerText = Math.round(totals.pro) + "g";
    document.getElementById("dashCar").innerText = Math.round(totals.car) + "g";
    document.getElementById("dashFat").innerText = Math.round(totals.fat) + "g";

    // Actualizar Barras
    updateBar("barKcal", "txtKcal", totals.cal, profile.calories);
    updateBar("barPro", "txtPro", totals.pro, profile.protein);
    updateBar("barCar", "txtCar", totals.car, profile.carbs);
    updateBar("barFat", "txtFat", totals.fat, profile.fat);

    // Actualizar Gr√°ficas (Si ChartJS carg√≥)
    if(typeof Chart !== 'undefined') {
        renderCharts(totals);
    }
}

function updateBar(barId, txtId, current, max) {
    let pct = (current / max) * 100;
    document.getElementById(barId).style.width = Math.min(pct, 100) + "%";
    document.getElementById(txtId).innerText = Math.round(pct) + "%";
    
    if(pct > 100) document.getElementById(barId).classList.add("over-limit");
    else document.getElementById(barId).classList.remove("over-limit");
}

function renderCharts(totals) {
    const ctxM = document.getElementById('macroChart').getContext('2d');
    const ctxW = document.getElementById('weeklyChart').getContext('2d');

    // Macro Chart
    if(chartMacro) chartMacro.destroy();
    chartMacro = new Chart(ctxM, {
        type: 'doughnut',
        data: {
            labels: ['Prote√≠na', 'Carbs', 'Grasa'],
            datasets: [{
                data: [totals.pro, totals.car, totals.fat],
                backgroundColor: ['#3b82f6','#eab308','#ef4444'],
                borderWidth: 0
            }]
        },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom', labels: { color: 'white' } } }
        }
    });

    // Weekly Chart
    let labels = [];
    let data = [];
    for(let i=6; i>=0; i--) {
        let d = new Date();
        d.setDate(d.getDate() - i);
        let k = d.toISOString().slice(0,10);
        labels.push(k.slice(8));
        let sum = (historyData[k] || []).reduce((a,b)=>a+b.cal,0);
        data.push(sum);
    }

    if(chartWeekly) chartWeekly.destroy();
    chartWeekly = new Chart(ctxW, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Kcal Semana',
                data: data,
                backgroundColor: '#22c55e',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { ticks: {color:'white'}, grid:{color:'#374151'} },
                x: { ticks: {color:'white'}, grid:{display:false} }
            },
            plugins: { legend: { display: false } }
        }
    });
}
</script>
</body>
</html>